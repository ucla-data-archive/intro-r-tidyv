---
title: "Data Visualization via ggplot2"
author: "Tim Dennis"
date: '2018-10-15'
teaching: 40
exercises: 15
questions: 
- "How can I read visualize data in R?"
keypoints:
- "Use `ggplot2` to create plots ."
- "Think about graphics in layers: aesthetics, geometry, statistics, scale transformation and grouping"
objectives:
- "To be able to use ggplot2 to generate publication quality graphics."
- "To apply geometry, aesthetic, and statisics layers to a ggplot plot."
- "To manipulate the aesthetics of a plot usng different colors, shapes, and lines."
- "To improve data visualization through transforming scales and paneling by group."
- 'To save a plot created with ggplot to disk.'
source: Rmd
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r images, include=FALSE}
include_image <- function(path,                           
                          html_opts = "width=45%",
                          latex_opts = html_opts,
                          alt_text = ""){
  if(knitr:::is_html_output()){
    glue::glue("![{alt_text}]({path}){{ {html_opts} }}")
  } else if(knitr:::is_latex_output()){
    glue::glue("![{alt_text}]({path}){{ {latex_opts} }}")    
  }
}

image_link <- function(path,
                       link,
                       html_opts = "height: 200px;",
                       latex_opts = "width=0.2\\textwidth",
                       alt_text = "",
                       centering = TRUE){
  if(knitr:::is_html_output()){
    if(centering){
    glue::glue('
      <center><a target="_blank" class="page-link" href="{link}"><img src="{path}" style="{html_opts}"/></a></center>')
    } else {
      glue::glue('
      <a target="_blank" class="page-link" href="{link}"><img src="{path}" style="{html_opts}"/></a>')
    }
  }
  else if(knitr:::is_latex_output()){
    if(centering){
      glue::glue('\\begin{{center}}
        \\href{{{link}}}{{\\includegraphics[{latex_opts}]{{{path}}}}}
        \\end{{center}}')
    } else
      glue::glue('\\href{{{link}}}{{\\includegraphics[{latex_opts}]{{{path}}}}}')
  }

}
```


```{r setup-viz, include=FALSE, purl=FALSE}
chap <- 3
lc <- 0
rq <- 0
# **`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`**
# **`r paste0("(RQ", chap, ".", (rq <- rq + 1), ")")`**

knitr::opts_chunk$set(
  tidy = FALSE,
  out.width = '\\textwidth',
  fig.height = 4,
  warning = FALSE
  )

# In knitr::kable printing replace all NA's with blanks
options(knitr.kable.NA = '')

# This bit of code is a bug fix on asis blocks, which we use to show/not show LC
# solutions, which are written like markdown text. In theory, it shouldn't be
# necessary for knitr versions <=1.11.6, but I've found I still need to for
# everything to knit properly in asis blocks. More info here:
# https://stackoverflow.com/questions/32944715/conditionally-display-block-of-markdown-text-using-knitr
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})

# This controls which LC solutions to show. Options for solutions_shown: "ALL"
# (to show all solutions), or subsets of c('3-2', '3-3',
# '3-4','3-5','3-6','3-7'), including the null vector c('') to show no
# solutions.
# solutions_shown <- c('3-1', '3-2', '3-3', '3-4', '3-5', '3-6' ,'3-7', '3-8', '3-9', '3-10', '3-11', '3-12', '3-13', '3-14')
solutions_shown <- c('')
show_solutions <- function(section){
  return(solutions_shown == "ALL" | section %in% solutions_shown)
}
```

## Introduction

* By visualizing our data, we will be able to gain valuable insights from our data that we couldn't see from just looking at the raw data in spreadsheet form.  
* We will use the `ggplot2` package because it provides an easy way to customize your plots and is rooted in the data visualization theory known as _The Grammar of Graphics_ [@wilkinson2005].
* **Graphics/plots/charts** provide a nice way for us to get a sense for how quantitative variables compare in terms of their **center** (where the values tend to be located) and their spread (how they vary around the center).  
* The most important thing to know about graphics is that they should be created to make it obvious for your audience to understand the findings and insight you want to get across.  
* This does however require a balancing act:
  * You want to highlight as many meaningful relationships and interesting findings as possible
  * **BUT** you don't want to include so many as to overwhelm your audience.  
* Identify patterns and outliers in our data.  

### Needed packages

Let's load all the packages needed for this chapter (this assumes you've already installed them). Read Section \@ref(packages) for information on how to install and load R packages.


```{r message=FALSE}
library(nycflights13)
library(ggplot2)
library(dplyr)
library(ggmap)
library(lubridate)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Packages needed internally, but not in text.
library(gapminder)
library(knitr)
library(kableExtra)
library(readr)
```


## The Grammar of Graphics {#grammarofgraphics}

* Start with a theoretical framework for data visualization known as the "The Grammar of Graphics," which serves as the basis for the `ggplot2` package.  
* Just like how we construct sentences in any language by using a linguistic grammar (nouns, verbs, subjects, objects, etc.), the theoretical framework given by Leland Wilkinson [@wilkinson2005] allows us to specify the components of a statistical graphic.

### Components of the Grammar

In short, the grammar tells us that:

> **A statistical graphic is a `mapping` of `data` variables to `aes`thetic attributes of `geom`etric objects.**

Specifically, we can break a graphic into the following three essential components:

1. `data`: the data-set comprised of variables that we map.
1. `geom`: the geometric object in question. This refers to our type of objects we can observe in our plot. For example, points, lines, bars, etc.
1. `aes`: aesthetic attributes of the geometric object that we can perceive on a graphic. For example, x/y position, color, shape, and size.  Each assigned aesthetic attribute can be mapped to a variable in our data-set.

### The ggplot2 package

* ggplot2 is an implementation of the g - o - g
* it's layered - think of photoshop - we define the data, specified  components, we then add *layers* to the plot using the `+` sign.
* The most essential layer to add to a plot is the specification of which type of `geom`etric object we want the plot to involve; e.g. points, lines, bars.
* Other layers we can add include the specification of the plot title, axes labels, facets, and visual themes for the plot.
* Let's now put the theory of the Grammar of Graphics into practice.

## Graphs - Some basic ways of visualizing data 

For our purposes, we will be limiting consideration a number different types of graphs. 

1. scatterplots
1. linegraphs
1. boxplots
1. histograms
1. barplots
1. maps

We will discuss some variations of these plots, but with this basic repertoire in your toolbox you can visualize a wide array of different data variable types. Note that certain plots are only appropriate for categorical/logical variables and others only for quantitative variables. You'll want to quiz yourself often as we go along on which plot makes sense a given a particular problem or data-set.

<!--Subsection on scatter plots-->
## Scatterplots {#scatterplots}

* simplest of the 5NG are *scatterplots* (also called bivariate plots);
* they allow you to investigate the relationship between two numerical variables.
* say we want to investigate the relationship between:
No good example data - but can add if find 

## Linegraphs {#linegraphs}

We'll use ridership data from MBTA Performance Dashboard for Boston for generating a line graph of average weekly ridership by each subway line. Let's load the data first: 

```{r read-riderdata}
rider_rawdata <- read_csv('data/mbta_ridership2016.csv')
View(rider_rawdata)
```

* Most frequently used when the x-axis represents time and the y-axis represents some other numerical variable; such plots are known as *time series*.  
* Time represents a variable that is connected together by each day following the previous day.  
* Linegraphs should be avoided when there is not a clear sequential ordering to the explanatory variable, i.e. the x-variable or the *predictor* variable.

Our focus now turns to the `MODE_TYPE` variable in this `ridership` data-set. We will set up a dplyr change to do a few things to prep this data for graphing. We will go into more in-depth how this works next week, but here's what we are doing: 

1. Since we only want to look at rail lines, let's filter by that in our dataframe. 
2. We also will take the opportunity to rename our varaibles so they easier to read on a graph


```{r}
railrides <- rider_rawdata %>%
  filter(MODE_TYPE =="RAIL") %>% 
  rename(Month = SERVICE_MONTH, Mode = MODE_TYPE, Avg_Weekday_Ridership = TOTAL_WEEKDAY_RIDERSHIP_COUNT, Line = ROUTE_OR_LINE) 
```

* The above selects only those rows in `rider_rawdata` where the mode type is `"RAIL"`.

### Linegraphs via geom_line {#geomline}

We plot a linegraph of average weekday ridership by month per rail 'line':

```{r avg_weekday_ride, fig.cap="Avg. Weekday MBTA Subway Ridership 2016"}
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership)) +
  geom_line()
```

Was this what you expected? 

* We wanted a line per rail line - this is aggregated across lines 
* Let's fix by adding a `group` component and `color` to ggplot 

```{r avg_weekday_ride_line, fig.cap="Avg. Weekday MBTA Subway Ridership 2016"}
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership,group=Line, color=Line)) +
  geom_line() 
```

* Ok what's wrong here? 
  * yes, the colors are off in the ledgend 
  * also let's fix the Y scale

```{r avg_weekday_scale-color, fig.cap="Avg. Weekday MBTA Subway Ridership 2016"}
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership,group=Line, color=Line)) +
  geom_line() + 
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(name="LINE",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

* ggplot is very granular in its settings. 

```{block lc-linegraph, type='learncheck', purl=FALSE}
**_Learning check_**
```

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`**  Why should linegraphs be avoided when there is not a clear ordering of the horizontal axis?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** Why are linegraphs frequently used when time is the explanatory variable?


```{asis lc-linegraph-solutions, include=show_solutions('3-5')}
**Learning Check Solutions**  
**`r paste0("(LC", chap, ".", (lc - 2), ")")`**: Why should linegraphs be avoided when there is not a clear ordering of the horizontal axis? *Because lines suggest connectedness and ordering.*  
**`r paste0("(LC", chap, ".", (lc - 1), ")")`**: Why are linegraphs frequently used when time is the explanatory variable? *Because time is sequential: subsequent observations are closely related to each other.*  
```


```{block, type='learncheck', purl=FALSE}
```

### Summary

Linegraphs, just like scatterplots, display the relationship between two numerical variables. However, the variable on the x-axis (i.e. the explanatory variable) should have a natural ordering, like some notion of time.  We can mislead our audience if that isn't the case.


## Barplots {#geombar}

### Barplots via geom_bar/geom_col

Stating the above differently:

* When the categorical variable you want to plot is not pre-counted in your data frame you need to use `geom_bar()`.
* When the categorical variable is pre-counted (in the above `fruits_counted` example in the variable `number`), you need to use `geom_col()` with the `y` aesthetic explicitly mapped.


In this table, the counts of the carriers are pre-counted. To create a barplot using the data frame `railrides`, we

* use `geom_col()` instead of `geom_bar()`
* map the `y` aesthetic to the variable `number`.

Compare this barplot using `geom_col` in Figure \@ref(fig:flightscol) with the earlier barplot using `geom_bar` in Figure \@ref(fig:flightsbar). They are identical. However the input data we used for these are different.

```{r flightscol, fig.cap='(ref:geomcol)', fig.height=2.5}
ggplot(data = railrides, mapping = aes(x = Line, y = Avg_Weekday_Ridership, fill=Line)) +
  geom_col() + facet_grid(~Month) 
```


```{block lc-barplot, type='learncheck', purl=FALSE}
**_Learning check_**
```

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** Why are histograms inappropriate for visualizing categorical variables?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What is the difference between histograms and barplots?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** How many Envoy Air flights departed NYC in 2013?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What was the seventh highest airline in terms of departed flights from NYC in 2013? How could we better present the table to get this answer quickly?


```{asis lc-barplot-solutions, include=show_solutions('3-10')}
**Learning Check Solutions**

* **`r paste0("(LC", chap, ".", (lc - 3), ")")`: Why are histograms inappropriate for visualizing categorical variables?** Histograms are for numerical variables i.e. the horizontal part of each histogram bar represents an interval, whereas for a categorical variable each bar represents only one level of the categorical variable.
* **`r paste0("(LC", chap, ".", (lc - 2), ")")`: What is the difference between histograms and barplots?** See above.
* **`r paste0("(LC", chap, ".", (lc - 1), ")")`: How many Envoy Air flights departed NYC in 2013?** Envoy Air is carrier code `MQ` and thus 26397 flights departed NYC in 2013.
* **`r paste0("(LC", chap, ".", (lc), ")")`: What was the seventh highest airline in terms of departed flights from NYC in 2013? How could we better present the table to get this answer quickly?** What a pain! We'll see in Chapter 5 on Data Wrangling that applying `arrange(desc(n))` will sort this table in descending order of `n`!

```

```{block, type='learncheck', purl=FALSE}
```

```{block, type='learncheck', purl=FALSE}
```

### Using barplots to compare two categorical variables

Barplots are the go-to way to visualize the frequency of different categories of a categorical variable. They make it easy to order the counts and to compare the frequencies of one group to another. Another use of barplots (unfortunately, sometimes inappropriately and confusingly) is to compare two categorical variables together.  Let's examine the distribution of outgoing flights from NYC by `carrier` and `airport`.


```{r, fig.cap="Stacked barplot comparing the number of flights by carrier and airport", fig.height=3.5}
ggplot(data = railrides,
       mapping = aes(x = Line, y=Avg_Weekday_Ridership, fill = Line)) +
  geom_col()  +
 scale_color_manual(name="Line",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

This plot is what is known as a *stacked barplot*.  While simple to make, it often leads to many problems. For example in this plot, it is difficult to compare the heights of the different colors (corresponding to the number of flights from each airport) between the bars (corresponding to the different carriers).

```{block lc-barplot-two-var, type='learncheck', purl=FALSE}
**_Learning check_**
```

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What kinds of questions are not easily answered by looking at the above figure?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What can you say, if anything, about the relationship between airline and airport in NYC in 2013 in regards to the number of departing flights?

```{asis lc-barplot-two-var-solutions, include=show_solutions('3-12')}
**Learning Check Solutions**

* **`r paste0("(LC", chap, ".", (lc - 1), ")")` What kinds of questions are not easily answered by looking at the above figure?** Because the red, green, and blue bars don't all start at 0 (only red does), it makes comparing counts hard.
```

```{block, type='learncheck', purl=FALSE}
```

Another variation on the stacked barplot is the *side-by-side barplot* also called a *dodged barplot*.

```{r, fig.cap="Side-by-side AKA dodged barplot comparing the number of flights by carrier and airport", fig.height=5}
ggplot(data = railrides,
       mapping = aes(x = Line, y =Avg_Weekday_Ridership, fill = factor(month(Month)))) +
  geom_col(position = "dodge")
```


```{block lc-barplot-stacked, type='learncheck', purl=FALSE}
**_Learning check_**
```

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** Why might the side-by-side (AKA dodged) barplot be preferable to a stacked barplot in this case?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What are the disadvantages of using a side-by-side (AKA dodged) barplot, in general?

```{asis lc-barplot-stacked-solutions, include=show_solutions('3-13')}
**Learning Check Solutions**

* **`r paste0("(LC", chap, ".", (lc - 1), ")")` Why might the side-by-side barplot be preferable to a stacked barplot in this case?** We can easily compare the different aiports for a given carrier using a single comparison line i.e. things are lined up
* **`r paste0("(LC", chap, ".", (lc - 0), ")")` What are the disadvantages of using a side-by-side barplot, in general?** It is hard to get totals for each airline.
```
```{block, type='learncheck', purl=FALSE}
```

Lastly, an often preferred type of barplot is the *faceted barplot*. This concept of faceting and small multiples.  This gives us a nicer way to compare the distributions across both `Line` and `Avg_Weekday_Ridership` by `Month`. We will also use the `lubridate` package to clean up the month. 

```{r facet-bar-vert, fig.cap="Faceted barplot comparing the number of flights by carrier and airport", fig.height=7.5}
ggplot(data = railrides,
       mapping = aes(x = Line, y = Avg_Weekday_Ridership, fill = Line)) +
  geom_col() +
  facet_wrap(~ month(Month, label=T), nrow = 5)
```


```{block lc-barplot-facet, type='learncheck', purl=FALSE}
**_Learning check_**
```

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** Why is the faceted barplot preferred to the side-by-side and stacked barplots in this case?

**`r paste0("(LC", chap, ".", (lc <- lc + 1), ")")`** What information about the different carriers at different airports is more easily seen in the faceted barplot?

```{asis lc-barplot-facet-solutions, include=show_solutions('3-14')}
**Learning Check Solutions**  

* **`r paste0("(LC", chap, ".", (lc - 1), ")")` Why is the faceted barplot preferred to the side-by-side and stacked barplots in this case?** Not that different than using side-by-side; depends on how you want to organize your presentation.
* **`r paste0("(LC", chap, ".", (lc), ")")` What information about the different carriers at different airports is more easily seen in the faceted barplot?** Now we can also compare the different carriers **within** a particular airport easily too. For example, we can read off who the top carrier for each airport is easily using a single horizontal line.
```

```{block, type='learncheck', purl=FALSE}
```

### Summary

Barplots are the preferred way of displaying categorical variables.  They are easy-to-understand and make it easy to compare across groups of a categorical variable.  When dealing with more than one categorical variable, faceted barplots are frequently preferred over side-by-side or stacked barplots.  Stacked barplots are sometimes nice to look at, but it is quite difficult to compare across the levels since the sizes of the bars are all of different sizes.  Side-by-side barplots can provide an improvement on this, but the issue about comparing across groups still must be dealt with.


### Mapping with reliabitliy data 



### Resources

An excellent resource as you begin to create plots using the `ggplot2` package is a cheatsheet that RStudio has put together entitled "Data Visualization with ggplot2" available

* by clicking [here](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf) or
* by clicking the RStudio Menu Bar -> Help -> Cheatsheets -> "Data Visualization with `ggplot2`"

This cheatsheet covers more than what we've discussed in this chapter but provides nice visual descriptions of what each function produces.

<!--
In addition, we've created a mind map to help you remember which types of plots are most appropriate in a given situation by identifying the types of variables involved in the problem.  It is available [here](https://coggle.it/diagram/V_G2gzukTDoQ-aZt-) and below.
-->

