---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 04-visualization.md in _episodes_rmd/
title: "Data Visualization via ggplot2"
author: "Tim Dennis"
date: '2018-10-15'
teaching: 40
exercises: 15
questions: 
- "How can I read visualize data in R?"
keypoints:
- "Use `ggplot2` to create plots ."
- "Think about graphics in layers: aesthetics, geometry, statistics, scale transformation and grouping"
objectives:
- "To be able to use ggplot2 to generate publication quality graphics."
- "To apply geometry, aesthetic, and statisics layers to a ggplot plot."
- "To manipulate the aesthetics of a plot usng different colors, shapes, and lines."
- "To improve data visualization through transforming scales and paneling by group."
- 'To save a plot created with ggplot to disk.'
source: Rmd
---







## Introduction

* By visualizing our data, we will be able to gain valuable insights from our data that we couldn't see from just looking at the raw data in spreadsheet form.  
* We will use the `ggplot2` package because it provides an easy way to customize your plots and is rooted in the data visualization theory known as _The Grammar of Graphics_ [@wilkinson2005].
* **Graphics/plots/charts** provide a nice way for us to get a sense for how quantitative variables compare in terms of their **center** (where the values tend to be located) and their spread (how they vary around the center).  
* The most important thing to know about graphics is that they should be created to make it obvious for your audience to understand the findings and insight you want to get across.  
* This does however require a balancing act:
  * You want to highlight as many meaningful relationships and interesting findings as possible
  * **BUT** you don't want to include so many as to overwhelm your audience.  
* Identify patterns and outliers in our data.  

### Needed packages

Let's load all the packages needed for this chapter (this assumes you've already installed them). Read Section \@ref(packages) for information on how to install and load R packages.



```r
library(nycflights13)
library(ggplot2)
library(dplyr)
library(ggmap)
library(lubridate)
```




## The Grammar of Graphics {#grammarofgraphics}

* Start with a theoretical framework for data visualization known as the "The Grammar of Graphics," which serves as the basis for the `ggplot2` package.  
* Just like how we construct sentences in any language by using a linguistic grammar (nouns, verbs, subjects, objects, etc.), the theoretical framework given by Leland Wilkinson [@wilkinson2005] allows us to specify the components of a statistical graphic.

### Components of the Grammar

In short, the grammar tells us that:

> **A statistical graphic is a `mapping` of `data` variables to `aes`thetic attributes of `geom`etric objects.**

Specifically, we can break a graphic into the following three essential components:

1. `data`: the data-set comprised of variables that we map.
1. `geom`: the geometric object in question. This refers to our type of objects we can observe in our plot. For example, points, lines, bars, etc.
1. `aes`: aesthetic attributes of the geometric object that we can perceive on a graphic. For example, x/y position, color, shape, and size.  Each assigned aesthetic attribute can be mapped to a variable in our data-set.

### The ggplot2 package

* ggplot2 is an implementation of the g - o - g
* it's layered - think of photoshop - we define the data, specified  components, we then add *layers* to the plot using the `+` sign.
* The most essential layer to add to a plot is the specification of which type of `geom`etric object we want the plot to involve; e.g. points, lines, bars.
* Other layers we can add include the specification of the plot title, axes labels, facets, and visual themes for the plot.
* Let's now put the theory of the Grammar of Graphics into practice.

## Graphs - Some basic ways of visualizing data 

For our purposes, we will be limiting consideration a number different types of graphs. 

1. scatterplots
1. linegraphs
1. boxplots
1. histograms
1. barplots
1. maps

We will discuss some variations of these plots, but with this basic repertoire in your toolbox you can visualize a wide array of different data variable types. Note that certain plots are only appropriate for categorical/logical variables and others only for quantitative variables. You'll want to quiz yourself often as we go along on which plot makes sense a given a particular problem or data-set.

<!--Subsection on scatter plots-->
## Scatterplots {#scatterplots}

* simplest of the 5NG are *scatterplots* (also called bivariate plots);
* they allow you to investigate the relationship between two numerical variables.
* say we want to investigate the relationship between:
No good example data - but can add if find 

## Linegraphs {#linegraphs}

We'll use ridership data from MBTA Performance Dashboard for Boston for generating a line graph of average weekly ridership by each subway line. Let's load the data first: 


```r
rider_rawdata <- read_csv('data/mbta_ridership2016.csv')
```

```
## Parsed with column specification:
## cols(
##   SERVICE_MONTH = col_date(format = ""),
##   MODE_TYPE = col_character(),
##   TOTAL_WEEKDAY_RIDERSHIP_COUNT = col_double(),
##   NUMBER_OF_WEEKDAYS = col_double(),
##   AVERAGE_WEEKDAY_RIDERSHIP_COUNT = col_double(),
##   ROUTE_OR_LINE = col_character()
## )
```

```r
#View(rider_rawdata)
```

* Most frequently used when the x-axis represents time and the y-axis represents some other numerical variable; such plots are known as *time series*.  
* Time represents a variable that is connected together by each day following the previous day.  
* Linegraphs should be avoided when there is not a clear sequential ordering to the explanatory variable, i.e. the x-variable or the *predictor* variable.

Our focus now turns to the `MODE_TYPE` variable in this `ridership` data-set. We will set up a dplyr change to do a few things to prep this data for graphing. We will go into more in-depth how this works next week, but here's what we are doing: 

1. Since we only want to look at rail lines, let's filter by that in our dataframe. 
2. We also will take the opportunity to rename our varaibles so they easier to read on a graph



```r
railrides <- rider_rawdata %>%
  filter(MODE_TYPE =="RAIL") %>% 
  rename(Month = SERVICE_MONTH, Mode = MODE_TYPE, Avg_Weekday_Ridership = TOTAL_WEEKDAY_RIDERSHIP_COUNT, Line = ROUTE_OR_LINE) 
```

* The above selects only those rows in `rider_rawdata` where the mode type is `"RAIL"`.

### Linegraphs via geom_line {#geomline}

We plot a linegraph of average weekday ridership by month per rail 'line':


```r
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership)) +
  geom_line()
```

<img src="figure/avg_weekday_ride-1.png" title="Avg. Weekday MBTA Subway Ridership 2016" alt="Avg. Weekday MBTA Subway Ridership 2016" width="\textwidth" />

Was this what you expected? 

* We wanted a line per rail line - this is aggregated across lines 
* Let's fix by adding a `group` component and `color` to ggplot 


```r
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership,group=Line, color=Line)) +
  geom_line() 
```

<img src="figure/avg_weekday_ride_line-1.png" title="Avg. Weekday MBTA Subway Ridership 2016" alt="Avg. Weekday MBTA Subway Ridership 2016" width="\textwidth" />

* Ok what's wrong here? 
  * yes, the colors are off in the ledgend 
  * also let's fix the Y scale


```r
ggplot(data = railrides,
       mapping = aes(x = Month, y = Avg_Weekday_Ridership,group=Line, color=Line)) +
  geom_line() + 
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(name="LINE",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

<img src="figure/avg_weekday_scale-color-1.png" title="Avg. Weekday MBTA Subway Ridership 2016" alt="Avg. Weekday MBTA Subway Ridership 2016" width="\textwidth" />

* ggplot is very granular in its settings. 

<div class="learncheck">
**_Learning check_**
</div>

**(LC3.1)**  Why should linegraphs be avoided when there is not a clear ordering of the horizontal axis?

**(LC3.2)** Why are linegraphs frequently used when time is the explanatory variable?





<div class="learncheck">

</div>

### Summary

Linegraphs display the relationship between two numerical variables. However, the variable on the x-axis (i.e. the explanatory variable) should have a natural ordering, like some notion of time.  We can mislead our audience if that isn't the case.


## Barplots

### Barplots via geom_bar/geom_col

Stating the above differently:

* When the categorical variable you want to plot is not pre-counted in your data frame you need to use `geom_bar()`.
* When the categorical variable is pre-counted, you need to use `geom_col()` with the `y` aesthetic explicitly mapped.


In this table, the counts of the `Lines` are pre-counted in `Avg_Weekday_Ridership`. To create a barplot using the data frame `railrides`, we

* use `geom_col()` instead of `geom_bar()`
* map the `y` aesthetic to the variable `Avg_Weekday_Ridership`.




```r
ggplot(data = railrides, mapping = aes(x = Line, y = Avg_Weekday_Ridership, fill=Line)) +
  geom_col() + facet_grid(~Month) 
```

<img src="figure/railrides-bar-1.png" title="(ref:geomcol)" alt="(ref:geomcol)" width="\textwidth" />
Like the line graph we can control the colors manually, but this time we need to use `scale_fill_manual()` 


```r
ggplot(data = railrides, mapping = aes(x = Line, y = Avg_Weekday_Ridership, fill=Line)) +
  geom_col() + 
  scale_fill_manual(name="LINE",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

<img src="figure/railrides-bar-color-1.png" title="(ref:geomcol)" alt="(ref:geomcol)" width="\textwidth" />

<div class="learncheck">
**_Learning check_**
</div>

**(LC3.3)** Why are histograms inappropriate for visualizing categorical variables?

**(LC3.4)** How many Envoy Air flights departed NYC in 2013?

**(LC3.5)** What was the seventh highest airline in terms of departed flights from NYC in 2013? How could we better present the table to get this answer quickly?




<div class="learncheck">

</div>

<div class="learncheck">

</div>

### Using barplots to compare two categorical variables

Barplots are the go-to way to visualize the frequency of different categories of a categorical variable. They make it easy to order the counts and to compare the frequencies of one group to another. Another use of barplots (unfortunately, sometimes inappropriately and confusingly) is to compare two categorical variables together.  Let's examine the distribution of outgoing flights from NYC by `carrier` and `airport`.



```r
ggplot(data = railrides,
       mapping = aes(x = Line, y=Avg_Weekday_Ridership, fill = Month)) +
  geom_col()  +
 scale_fill_manual(name="Line",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

```
## Error: Continuous value supplied to discrete scale
```

<img src="figure/unnamed-chunk-7-1.png" title="Stacked barplot comparing the Avg. Weekday Ridership by Line and Month" alt="Stacked barplot comparing the Avg. Weekday Ridership by Line and Month" width="\textwidth" />
Ok, what happened here? 

* R is treating Month as a continuous variable (a number), when we want a category - known in R as a factor. 
* We can make R treat Month as a factor on the fly by wrapping it in the `factor()` function


```r
ggplot(data = railrides,
       mapping = aes(x = Line, y=Avg_Weekday_Ridership, fill = factor(Month))) +
  geom_col()  
```

<img src="figure/unnamed-chunk-8-1.png" title="Stacked barplot comparing the Avg. Weekday Ridership by Line and Month" alt="Stacked barplot comparing the Avg. Weekday Ridership by Line and Month" width="\textwidth" />

This plot is what is known as a *stacked barplot*.  While simple to make, it often leads to many problems. For example in this plot, it is difficult to compare the heights of the different colors (corresponding to the number of flights from each airport) between the bars (corresponding to the different carriers).

<div class="learncheck">
**_Learning check_**
</div>

**(LC3.6)** What kinds of questions are not easily answered by looking at the above figure?

**(LC3.7)** What can you say, if anything, about the relationship between airline and airport in NYC in 2013 in regards to the number of departing flights?



<div class="learncheck">

</div>

Another variation on the stacked barplot is the *side-by-side barplot* also called a *dodged barplot*.


```r
ggplot(data = railrides,
       mapping = aes(x = Line, y =Avg_Weekday_Ridership, fill = factor(month(Month)))) +
  geom_col(position = "dodge")
```

<img src="figure/unnamed-chunk-10-1.png" title="Side-by-side AKA dodged barplot comparing the number of flights by carrier and airport" alt="Side-by-side AKA dodged barplot comparing the number of flights by carrier and airport" width="\textwidth" />


<div class="learncheck">
**_Learning check_**
</div>

**(LC3.8)** Why might the side-by-side (AKA dodged) barplot be preferable to a stacked barplot in this case?

**(LC3.9)** What are the disadvantages of using a side-by-side (AKA dodged) barplot, in general?


<div class="learncheck">

</div>

Lastly, an often preferred type of barplot is the *faceted barplot*. This concept of faceting and small multiples.  This gives us a nicer way to compare the distributions across both `Line` and `Avg_Weekday_Ridership` by `Month`. We will also use the `lubridate` package to clean up the month. 


```r
ggplot(data = railrides,
       mapping = aes(x = Line, y = Avg_Weekday_Ridership, fill = Line)) +
  geom_col() +
  facet_wrap(~ month(Month, label=T), nrow = 5) +
  scale_fill_manual(name="Line",values=c("BLUE LINE"="blue","GREEN LINE"="green","ORANGE LINE"="orange","RED LINE"="red"))
```

<img src="figure/facet-bar-vert-1.png" title="Faceted barplot comparing the number of flights by carrier and airport" alt="Faceted barplot comparing the number of flights by carrier and airport" width="\textwidth" />

We did a few things here to clean it up. I used `lubridates` (a package to work with dates) function `month` function to turn our month into a better label. this happens inside the facet function. 

<div class="learncheck">
**_Learning check_**
</div>

**(LC3.10)** Why is the faceted barplot preferred to the side-by-side and stacked barplots in this case?

**(LC3.11)** What information about the different carriers at different airports is more easily seen in the faceted barplot?



<div class="learncheck">

</div>

### Summary

Barplots are the preferred way of displaying categorical variables.  They are easy-to-understand and make it easy to compare across groups of a categorical variable.  When dealing with more than one categorical variable, faceted barplots are frequently preferred over side-by-side or stacked barplots.  Stacked barplots are sometimes nice to look at, but it is quite difficult to compare across the levels since the sizes of the bars are all of different sizes.  Side-by-side barplots can provide an improvement on this, but the issue about comparing across groups still must be dealt with.


### Mapping with reliabitliy data 

Source: Largely taken from <http://transitdatatoolkit.com/lessons/reliability/>, but coe rewritten in a tidyverse manner. 

This lesson introduces using transit data to measure the reliability of a transit system. In this lesson, we will be using R and RStudio. If you haven’t set up these tools.

* We will be using MBTA Wait Time Reliability data for the Green Line to examine the peak hour reliability of each station served by Boston’s Green Line for this lesson
* We will map each station’s reliability
* We will only be looking at one month of the year to keep the data a manageable size.
* We are working with this file `TDashboardData_reliability_20160301-20160331.csv` in your  Working Directory
* Look at the Data Dictionary < https://massdot.app.box.com/v/dashboard-data-dictionary> This PDF describes all the fields in the dataset. 
* MBTA did a good job documenting their data. You may find other datasets have poor documentation. In these cases, you will need to investigate what the fields mean by searching the internet or contacting the organization that produces the data.

> ## Reading Data Dictionary
> Read the definitions of “OTP_NUMERATOR” and “OTP_DENOMINATOR” for “rail.” What data do these fields contain?
>
> The OTP_NUMERATOR for rail is the estimated number of passengers on that day for that transit station, whose wait time was longer than scheduled.
>
> The OTP_DENOMINATOR for rail is the estimated number of total passengers on that day for that transit station.
{: .callout}

#### First steps - Prepare the data

* Many say 60-80% of the work in a data science project is spent in preparing the data for analysis 

We first want to work with the reliability data.

1. Take `rawdata` and pipe through `filter()`
1. Filter by peak service (weekday rush hour)
1. Filter by only the green line
1. Mutate to create or overwrite a variable 
1. str_trim to remove whitespaces before and after values
1. Create a rely variable that 
1. Finds the reliability at each station
1. Divides the numerator (people who have to wait too long) by the denominator (all riders).
1. This is the percentage of people who had to wait. 1 - this ratio is the percentage of people who didn't.
1. drop the columns we don't need for futher analysis



### Resources

An excellent resource as you begin to create plots using the `ggplot2` package is a cheatsheet that RStudio has put together entitled "Data Visualization with ggplot2" available

* by clicking [here](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf) or
* by clicking the RStudio Menu Bar -> Help -> Cheatsheets -> "Data Visualization with `ggplot2`"

This cheatsheet covers more than what we've discussed in this chapter but provides nice visual descriptions of what each function produces.

<!--
In addition, we've created a mind map to help you remember which types of plots are most appropriate in a given situation by identifying the types of variables involved in the problem.  It is available [here](https://coggle.it/diagram/V_G2gzukTDoQ-aZt-) and below.
-->

